# ChatVibe
聊聊乐项目-C++

## 使用
- 服务端在VS中，客户端在QT中，都已将其复制到该文件，使用时，先运行服务端，再运行客户端。若想启用多个用户，可将QT的Debug模式改为Release模式，然后构建会有一个路径，有个exe文件，每次点击都会有一个登录窗口，即可登录。
- 注意每次运行需要注意IP地址是否改变，在QT中的packDef.h中检查，可通过命令提示符窗口查看地址。

## 服务端
- 核心组件
  1. **IKernel（核心接口）**
     * 作为服务端的核心接口，定义了服务端的基本功能和组件。
	   * 包含了CMySql和INetMediator两个特性，分别代表数据库操作和网络中介接口。
  2. **INetMediator（网络中介接口）**
     * 定义了网络通信的基本操作，包括打开网络、发送数据、关闭网络和数据处理。
	   * 被UdpMediator和TcpMediator两个类继承，分别实现了基于UDP和TCP协议的网络通信。
    
  3. **CMySql（数据库操作类）**
     * 负责与MySQL数据库进行交互，实现数据的存储、查询、更新和删除等操作。
	   * 作为IKernel接口的一个特性，表明服务端需要数据库支持。
    
  4. **UdpMediator和TcpMediator（网络中介实现类）**
     * 分别继承自INetMediator接口，实现了基于UDP和TCP协议的网络通信功能。
	   * 包含了INet特性，表明它们可以与网络层进行交互。
	   * 实现了打开网络、发送数据、关闭网络和数据处理等虚拟函数，提供了具体的网络通信实现。
    
  5. **UdpNet和TcpNet（网络层实现类）**
	   * 分别实现了基于UDP和TCP协议的网络层功能。
	   * 包含了INetMediator特性，表明它们可以与网络中介层进行交互。
	   * 实现了网络初始化、发送数据、接收数据和网络反初始化等操作。

- 逻辑关系
  1. 继承关系：UdpMediator和TcpMediator继承自INetMediator接口，实现了网络通信的具体功能。
  2. 组合关系：IKernel接口包含了CMySql和INetMediator两个特性，表明服务端需要同时具备数据库操作和网络通信功能。
  3. 依赖关系：UdpMediator和TcpMediator依赖于UdpNet和TcpNet实现具体的网络通信功能。
 
- 功能实现
  1. 网络通信：通过UdpMediator和TcpMediator实现基于UDP和TCP协议的网络通信，包括数据的发送和接收。
  2. 数据处理：通过INetMediator接口的定义和实现，对接收到的数据进行处理和响应。
  3. 数据库操作：通过CMySql类实现与MySQL数据库的交互，支持数据的存储和管理。

## 客户端
- 核心组件
  1. **UI11**（用户界面）
  2. **INetMediator1**（网络中介接口）
  3. **INet1**（网络接口）
  4. **IKernel1**（内核接口）
  5. **UdpMediator1** 和 **TcpMediator1**（UDP和TCP网络中介实现）
  6. **UdpNet1** 和 **TcpNet1**（UDP和TCP网络实现）
 
- 逻辑关系
  1. 继承关系:
     - `UdpMediator1` 和 `TcpMediator1` 继承自 `INetMediator1` 接口，实现了网络中介的具体功能。
     - `UdpNet1` 和 `TcpNet1` 继承自 `INet1` 接口，实现了网络层的具体功能。
    
  2. 组合关系:
     - `IKernel1` 包含 `INetMediator*` 和 `UI*` 特性，表示内核需要网络中介和用户界面的支持。
     - `INetMediator1` 包含 `INet*` 特性，表示网络中介需要网络层的支持。
    
  3. 依赖关系:
     - `UdpMediator1` 和 `TcpMediator1` 依赖于 `UdpNet1` 和 `TcpNet1` 实现具体的网络通信功能。
    
- 功能实现
  1. 用户界面 (UI11): 提供用户与系统交互的界面。
  2. 网络中介 (INetMediator1): 定义了网络通信的基本操作，如打开网络、发送数据、关闭网络和处理数据。
  3. 网络层 (INet1): 定义了网络初始化、发送数据、接收数据和反初始化的操作。
  4. 内核 (IKernel1): 整合了用户界面和网络中介的功能，作为系统的核心部分。

## 项目总结
1. 优化点
   1. 服务器是在windows平台下，使用的是简单的同步阻塞多线程模型，一个客户端一个线程。进程空间是有上限的，自然线程不能无限制创建，所以当客户端达到一定基数，会程序奔溃，因为空间不够。32位的windows中，操作系统会给进程分配0～4G线性内存空间。其中0～2G为应用程序内存空间（处于其中每一个进程都有独立的内存空间），2G～4G为系统内核空间（内核进程彻底共享）。那么进程的最大可用内存就是2G，因为每一个线程栈的默认大小是1MB，理论上最多建立2048个线程，实际进程中还有一些其余地方占用内存，因此通常状况下可建立的线程总数为2000个左右<!--这个是同时登录用户的数量，而注册用户数量的大小取决于数据库的大小-->。 解决方法：可以使用多路复用网络IO模型(linux阶段)，使服务端在Linux上，客户端在Windows上。
   2. 添加好友，名字没有确认唯一；在注册的时候，如果名字是重复的，是不允许注册成功；同一个用户可以同时登录多次。
   3. 异常场景处理：当用户应用异常退出，没有发送离线请求，服务器中相关的map项没有回收，导致后面通讯、状态异常、发送信息没有用户离线的提示。解决方法（心跳机制）：加tcp的确认，做法仿照微信，用定时器(QTimer) ，每次发送数据，开启定时，定时结束没有收到确认，提示用户，发送失败，以确保可靠通讯。

2. 扩展点
   1. 截屏
   2. 发表情：按钮 -> 表情图片 -> 按钮有id :/bq/id.png 插入到 ui-> tb_chat控件中
   3. 远程桌面(协助 – 钩子 hook 抓取事件 发送 ) : 桌面截图实现的思想都是tcp转发
   4. 对方不在线时，保存发送的聊天记录（先存到数据库中）
   5. 增加游戏功能---自己玩自己的，最后比较结果  or  两个人一起玩
